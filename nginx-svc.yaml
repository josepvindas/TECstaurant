apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-conf
data:
  default.conf: |
    server {
      listen 80;
      # catalog_service routes
      location /catalog {
        proxy_pass http://catalog_service:4000/locations;
      }

      location /catalog/:id {
        proxy_pass http://catalog_service:4000/locations/:id;
      }

      location /catalog/:id/menu {
        proxy_pass http://catalog_service:4000/locations/:id/menu;
      }

      location /catalog/:id/services {
        proxy_pass http://catalog_service:4000/locations/:id/services;
      }

      location /catalog/:id/all {
        proxy_pass http://catalog_service:4000/locations/:id/all;
      }

        location /catalog/products {
        proxy_pass http://catalog_service:4000/products;
      }

          location /catalog/products/:id {
        proxy_pass http://catalog_service:4000/products/:id;
      }

        location /catalog/services {
        proxy_pass http://catalog_service:4000/services;
      }

          location /catalog/services/:id {
        proxy_pass http://catalog_service:4000/services/:id;
      }

      # report-service routes
      location /reports{
        proxy_pass http://report_service:80/locations;
      }

    }
---
apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: nginx
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
        - name: nginx
          image: nginx
          ports:
            - containerPort: 80
          volumeMounts:
            - mountPath: /etc/nginx/conf.d/default.conf
              subPath: default.conf
      volumes:
        - name: nginx-conf
          configMap:
            name: nginx-conf

---
apiVersion: v1
kind: Service
metadata:
  name: nginx
spec:
  type: LoadBalancer
  ports:
    - port: 80
      targetPort: 80
  selector:
    app: nginx
